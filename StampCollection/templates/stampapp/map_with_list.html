{% extends "base.html" %}
{% load static %}

{% block head %}
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.3.1/dist/leaflet.css" integrity="sha512Rksm5RenBEKSKFjgI3a41vrjkw4EVPlJ3+OiI65vTjIdo9brlAacEuKOiQ5OFh7cOI1bkDwLqdLw3Zg0cRJAAQ==" crossorigin=""/>
  <script src="https://unpkg.com/leaflet@1.3.1/dist/leaflet.js" integrity="sha512-/Nsx9X4HebavoBvEBuyp3I7od5tA0UzAxs+j83KgC8PU0kgB4XiK4Lfe4y4cgBtaRJQEIFCW+oC506aPT2L1zw==" crossorigin=""></script>
  <link rel="stylesheet" href="{% static 'css/stamp_list.css' %}">
<style>

  .page-container {
  display: flex;
  flex-direction: column; /* ← 縦並び確定 */
  gap: 16px;
  width: 100%;
  }

  #map {
    height: 400px;
    width: 70%;
    margin-top: 300px;
    padding-top: 100px;
    margin-bottom: 0px;
    position: relative;

  }
  .header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 10px;
  }
</style>
{% endblock head %}

{% block content %}

<h1 class="page-title">スタンプ一覧とマップ</h1>

<div class="page-container">

<div id="map"></div>

 <div class="stamp-list">
  <div class="grid">
   {% for own_stamp in own_stamps %}
    <div class="cell">
      <div class="stamp-wrapper">
        <span class="got-badge">GOT</span>
        <a href="{% url 'stamp_detail' own_stamp %}">
          <img class="rsquare-img" src="{{ own_stamp.stamp_image.url }}">
        </a>
      </div>
      <div class="stamp-name">{{ own_stamp }}</div>
    </div>
  {% endfor %}
  {% for unknown_stamp in unknown_stamps %}
    <div class="cell">
      <div class="stamp-wrapper">
        <span class="unknown_badge">UNKNOWN</span>
        <a href="{% url 'stamp_detail' unknown_stamp %}">
          <canvas class="rsquare-img" id="canvas_{{ unknown_stamp.id }}"></canvas>
        </a>
      </div>
      <div class="stamp-name">{{ unknown_stamp }}</div>
    </div>
  {% endfor %}
</div>
 </div>
</div>
{% endblock content %}

<!-- UNKNOWNスタンプ描画 -->
{% block script %}
<script>
// マップ作成
let map = L.map('map');

// タイル
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
}).addTo(map);

// スタンプのピンを追加し、詳細ページに遷移するための処理(12/9追加)
{% for stamp in stamps %}
    // マーカー作成
    let marker_{{ stamp }} = L.marker([{{ stamp.latitude }}, {{ stamp.longitude }}]).addTo(map).bindPopup("<b>{{ stamp }}</b>");

    // クリックで詳細ページに移動
    marker_{{ stamp }}.on("click", () => {
        window.location.href = "{% url 'stamp_detail' stamp %}";
    });

    // マウスをピンに被せたとき, ピンの名前を表示
    marker_{{ stamp }}.on("mouseover", () => {
      marker_{{ stamp }}.openPopup();
    })
    marker_{{ stamp }}.on("mouseout", () => {
      marker_{{ stamp }}.closePopup();
    })
{% endfor %}

// 地図の中心位置を指定
map.setView([42.316, 140.99], 14)



  {% for unknown_stamp in unknown_stamps %}
    draw_image({{ unknown_stamp.id  }}, "{{ unknown_stamp.stamp_image.url }}")
  {% endfor %}
</script>
{% endblock script %}

{% block redirect %}
<a href='{% url "home" %}'>ホーム</a>
{% endblock redirect %}