{% extends "base.html" %}
{% load static %}

{% block head %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.3.1/dist/leaflet.css">
<script src="https://unpkg.com/leaflet@1.3.1/dist/leaflet.js"></script>

<style>
#map {
  height: 80vh;
  width: 100%;
}

/* フォームは画面前面に固定 */
#stamp-form {
  position: fixed;
  top: 20%;
  left: 50%;
  transform: translateX(-50%);
  background: white;
  padding: 20px;
  border-radius: 8px;
  z-index: 2000;
  display: none;
  box-shadow: 0 0 15px rgba(0,0,0,0.3);
}
</style>
{% endblock head %}

{% block title %}
<h2>全体マップ</h2>
{% endblock title %}

{% block content %}
<div id="map"></div>

<div id="stamp-form">
  <h3>スタンプを追加</h3>

  <form method="POST" enctype="multipart/form-data"
        action="{% url 'result_add_stamp_pin' %}">
    {% csrf_token %}

    <label>スタンプ名</label><br>
    <input type="text" name="name" required><br><br>

    <input type="hidden" name="latitude" id="latitude">
    <input type="hidden" name="longitude" id="longitude">

    <label>スタンプ画像</label><br>
    <input type="file" name="stamp_image" required><br><br>

    <button type="submit">ここにスタンプを追加</button>
    <button type="button" id="cancel-add">キャンセル</button>
  </form>
</div>
{% endblock content %}

{% block script %}
<script>
const map = L.map('map').setView([42.316, 140.99], 14);

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  attribution: '&copy; OpenStreetMap contributors'
}).addTo(map);

// 既存スタンプ
{% for stamp in stamps %}
L.marker([{{ stamp.latitude }}, {{ stamp.longitude }}])
  .addTo(map)
  .bindPopup("<b>{{ stamp.name }}</b>")
  .on("click", () => {
    window.location.href = "{% url 'stamp_detail' stamp.name %}";
  });
{% endfor %}

let tempMarker = null;

map.on('click', function(e) {
  const lat = e.latlng.lat;
  const lng = e.latlng.lng;

  if (tempMarker) {
    map.removeLayer(tempMarker);
  }

  tempMarker = L.marker([lat, lng]).addTo(map);

  document.getElementById("latitude").value = lat;
  document.getElementById("longitude").value = lng;
  document.getElementById("stamp-form").style.display = "block";

  // 地図のクリックを一時停止
  map.getContainer().style.pointerEvents = "none";
});

// キャンセル処理
document.getElementById("cancel-add").addEventListener("click", () => {
  if (tempMarker) {
    map.removeLayer(tempMarker);
    tempMarker = null;
  }
  document.getElementById("stamp-form").style.display = "none";
  map.getContainer().style.pointerEvents = "auto";
});
</script>
{% endblock script %}
