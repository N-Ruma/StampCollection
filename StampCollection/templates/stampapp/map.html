{% extends "base.html" %}
{% load static %}

{% block head %}
  <link rel="stylesheet" href="{% static 'css/add_stamp_pin.css' %}">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.3.1/dist/leaflet.css" integrity="sha512Rksm5RenBEKSKFjgI3a41vrjkw4EVPlJ3+OiI65vTjIdo9brlAacEuKOiQ5OFh7cOI1bkDwLqdLw3Zg0cRJAAQ==" crossorigin=""/>
  <script src="https://unpkg.com/leaflet@1.3.1/dist/leaflet.js" integrity="sha512-/Nsx9X4HebavoBvEBuyp3I7od5tA0UzAxs+j83KgC8PU0kgB4XiK4Lfe4y4cgBtaRJQEIFCW+oC506aPT2L1zw==" crossorigin=""></script>
{% endblock head %}

{% block title %}
<h2>全体マップ</h2>
{% endblock title %}

{% block content %}
<div id="map"></div>

<div class="stamp-card" id="stamp-card" style="display: none;">
  <h2>スタンプを追加</h2>

  {% if form.errors %}
    {% for key, errors in form.errors.items %}
      {% for error in errors %}
        <p class="error-text">{{ error }}</p>
      {% endfor %}
    {% endfor %}
  {% endif %}

  <form method="POST" enctype="multipart/form-data" action="{% url 'result_add_stamp_pin' %}">
    {% csrf_token %}

    <label for="name">スタンプ名:</label>
    {{ form.name }}

    <label for="latitude">緯度:</label>
    {{ form.latitude }}

    <label for="longitude">経度:</label>
    {{ form.longitude }}
    <input type="hidden" name="latitude" id="latitude">
    <input type="hidden" name="longitude" id="longitude">

    <label for="stamp_image">スタンプ画像:</label>
    {{ form.stamp_image }}

    <button type="submit">ここにスタンプを追加</button>
    <button type="button" id="cancel-add">キャンセル</button>
  </form>
  <a href="{% url 'home' %}" class="home-link">ホームへ戻る</a>
</div>
{% endblock content %}

{% block script %}
<script>
const map = L.map('map').setView([42.316, 140.99], 14);

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  attribution: '&copy; OpenStreetMap contributors'
}).addTo(map);

// 既存スタンプ
{% for stamp in stamps %}
  // マーカー作成
  let marker_{{ stamp }} = L.marker([{{ stamp.latitude }}, {{ stamp.longitude }}]).addTo(map).bindPopup("<b>{{ stamp }}</b>");

  // クリックで詳細ページに移動
  marker_{{ stamp }}.on("click", () => {
      window.location.href = "{% url 'stamp_detail' stamp %}";
  });

  // マウスをピンに被せたとき, ピンの名前を表示
  marker_{{ stamp }}.on("mouseover", () => {
    marker_{{ stamp }}.openPopup();
  })
  marker_{{ stamp }}.on("mouseout", () => {
    marker_{{ stamp }}.closePopup();
  })
{% endfor %}

let tempMarker = null;

map.on('click', function(e) {
  const lat = e.latlng.lat;
  const lng = e.latlng.lng;

  if (tempMarker) {
    map.removeLayer(tempMarker);
  }

  tempMarker = L.marker([lat, lng]).addTo(map);

  document.getElementById("latitude").value = lat;
  document.getElementById("longitude").value = lng;
  document.getElementById("stamp-card").style.display = "block";

  // 地図のクリックを一時停止
  map.getContainer().style.pointerEvents = "none";
});

// キャンセル処理
document.getElementById("cancel-add").addEventListener("click", () => {
  if (tempMarker) {
    map.removeLayer(tempMarker);
    tempMarker = null;
  }
  document.getElementById("stamp-card").style.display = "none";
  map.getContainer().style.pointerEvents = "auto";
});
</script>
{% endblock script %}
